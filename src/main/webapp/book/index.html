<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>图书信息维护</title>
    <link rel="stylesheet" href="../css/bootstrap.css"/>
    <link rel="stylesheet" href="../css/jquery-ui.css"/>
    <style>
        #save-form{
            margin-top: 30px;
        }

    </style>
</head>
<body>
<div class="container">
    <form id="list-form" class="form-inline">
        <div class="form-group">
            <input id="name" placeholder="书名" class="form-control"/>
        </div>
        <div class="form-group">
            <input id="begin" type="date" class="form-control"/>
        </div>
        <div class="form-group">
            <input id="end" type="date" class="form-control"/>
        </div>
        <button id="list-btn" type="button" class="btn btn-success">查询</button>
    </form>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>序号</th>
                <th>书名</th>
                <th>作者</th>
                <th>出版社</th>
                <th>出版日期</th>
                <th>价格</th>
                <th>库存</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="data-body">

        </tbody>
    </table>
    <p class="text-right">
        第<span id="first"></span>~<span id="last"></span>条/共<span id="amount"></span>数据 第<span id="pageNum"></span>页/共<span id="pageAmount"></span>页
        <button class="btn page-btn">&lt;&lt;</button>
        <button class="btn page-btn">&lt;</button>
        <input id="pageNo" value="1" form="list-form" />
        <select id="pageSize" form="list-form">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
        </select>
        <button class="btn page-btn">&gt;</button>
        <button class="btn page-btn">&gt;&gt;</button>
    </p>
    
    <form id="save-form" class="form-horizontal col-lg-6 col-lg-offset-3">
        <div class="form-group">
            <label for="bookName" class="control-label col-lg-2">书名</label>
            <div class="col-lg-10">
                <input id="bookName" placeholder="书名" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="author" class="control-label col-lg-2">作者</label>
            <div class="col-lg-10">
                <input id="author" placeholder="作者" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="press" class="control-label col-lg-2">出版社</label>
            <div class="col-lg-10">
                <input id="press" placeholder="出版社" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="pubDate" class="control-label col-lg-2">出版日期</label>
            <div class="col-lg-10">
                <input id="pubDate" placeholder="出版日期" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="price" class="control-label col-lg-2">价格</label>
            <div class="col-lg-10">
                <input id="price" placeholder="价格" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="bookAmount" class="control-label col-lg-2">库存</label>
            <div class="col-lg-10">
                <input id="bookAmount" placeholder="库存" class="form-control"/>
            </div>
        </div>
        <div class="text-center">
            <button id="save-btn" type="button" class="btn btn-success">保存</button>
            <button type="reset" class="btn btn-warning">重置</button>
        </div>
    </form>
</div>
<div id="edit-dialog" title="修改书籍信息">
    <form id="edit-form" class="form-horizontal col-lg-10 col-lg-offset-1">
        <div class="form-group">
            <label for="edit-bookName" class="control-label col-lg-3">书名</label>
            <div class="col-lg-9">
                <input id="edit-bookName" placeholder="书名" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="edit-author" class="control-label col-lg-3">作者</label>
            <div class="col-lg-9">
                <input id="edit-author" placeholder="作者" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="edit-press" class="control-label col-lg-3">出版社</label>
            <div class="col-lg-9">
                <input id="edit-press" placeholder="出版社" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="edit-pubDate" class="control-label col-lg-3">出版日期</label>
            <div class="col-lg-9">
                <input id="edit-pubDate" placeholder="出版日期" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="edit-price" class="control-label col-lg-3">价格</label>
            <div class="col-lg-9">
                <input id="edit-price" placeholder="价格" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label for="edit-bookAmount" class="control-label col-lg-3">库存</label>
            <div class="col-lg-9">
                <input id="edit-bookAmount" placeholder="库存" class="form-control"/>
            </div>
        </div>
    </form>
</div>
<div id="msg-dialog" title="">
    <p id="msg-text"></p>
</div>
<script src="../js/jquery-3.2.1.js"></script>
<script src="../js/bootstrap.js"></script>
<script src="../js/jquery-ui.js"></script>
<!--<div class="text-center">
    <button id="update-btn" type="button" class="btn btn-success">修改</button>
    <button type="reset" class="btn btn-warning">重置</button>
</div>-->
<script>
    let lastPage = 0;

    let editDialog = $("#edit-dialog").dialog({
        autoOpen:false,
        modal:true,
        width:550,
        height:460,
        buttons:[{
            text:"修改",
            click:function(){
                // 执行AJAX
            }
        },{
            text:"重置",
            click:function () {
                $("#edit-form").get(0).reset();
            }
        }]
    });

    $(function () {
        list();
        $('#list-btn').click(list);
        $("#pageSize").change(list);
        let pageBtns = $(".page-btn");
        $(pageBtns[0]).click(toFirstPage);
        $(pageBtns[1]).click(prePage);
        $(pageBtns[2]).click(nextPage);
        $(pageBtns[3]).click(toLastPage);

        $("#save-btn").click(save);

        $('#data-body').on('click','.open-edit-dialog-btn',function () {
            editDialog.dialog('open');
        });
    });

    let save = function () {
        let book = {
            "name":$("#bookName").val(),
            "press":$("#press").val(),
            "author":$("#author").val(),
            "price":$("#price").val(),
            "pubDate":$("#pubDate").val(),
            "amount":$("#bookAmount").val()
        };

        let bookJSON = JSON.stringify(book);

        $.ajax({
            url:"save.do",
            type:"POST",
            data:bookJSON,
            dataType:"json",
            contentType:"application/json"
        }).then(function (ro) {
            let msgDialog = $("#msg-dialog").dialog({
                autoOpen:false,
                title:ro.typeChineseDes
            });

            $("#msg-text").html(ro.msg);
            msgDialog.dialog('open');

            let dateStrArr = book.pubDate.split("-");
            book.pubDate = dateStrArr[0]+"年"+dateStrArr[1]+"月";

            let newTr = "<tr>" +
                "<td>1</td>"+
                "<td>"+book.name+"</td>"+
                "<td>"+book.author+"</td>"+
                "<td>"+book.press+"</td>"+
                "<td>"+book.pubDate+"</td>"+
                "<td>"+book.price+"</td>"+
                "<td>"+book.amount+"</td>"+
                "<td><button>修改</button></td>"+
                "</tr>";

            let oldTrs = $("tr","#data-body");
            oldTrs.remove("tr:last");
            $("#data-body").prepend(newTr);

            for(let i = 0;i<oldTrs.length;i++){
                oldTrs[i].children[0].innerText = (i+2);
            }

            $("#save-form").get(0).reset();
        },function (xhr) {
            let msgDialog = $("#msg-dialog").dialog({
                autoOpen:false,
                title:ro.typeChineseDes
            });
            $("#msg-text").html(ro.msg);
            msgDialog.dialog('open');
        });
    }

    let list = function () {
        let tbody = $("#data-body");
        // 封装表单数据为JSON
        let qo = {
            "name":$("#name").val(),
            "begin":$("#begin").val(),
            "end":$("#end").val(),
            "pageNo":$("#pageNo").val(),
            "pageSize":$("#pageSize").val()
        };

        let jsonStr = JSON.stringify(qo);

        // 调用AJAX请求得到RO的JSON
        $.ajax({
            url:"list.do",
            type:"POST",
            data:jsonStr,
            dataType:"json",
            contentType:"application/json"
        }).then(function (ro) {
            tbody.empty();
            if(ro.emptyData){
                tbody.html("<tr><td colspan='8' class='text-danger text-center'>未查询到符合条件的书籍信息</td></tr>");
            }else{
                let trs = "";
                $.each(ro.data,function (i,b) {
                    trs = trs + "<tr>" +
                        "<td>"+(i+1)+"</td>"+
                        "<td>"+b.name+"</td>"+
                        "<td>"+b.author+"</td>"+
                        "<td>"+b.press+"</td>"+
                        "<td>"+b.pubDateStr+"</td>"+
                        "<td>"+b.price+"</td>"+
                        "<td>"+b.amount+"</td>"+
                        "<td><button title='修改' class='btn btn-link text-danger open-edit-dialog-btn' data-id='"+b.id+"'><span class='glyphicon glyphicon-edit'></span></button></td>"+
                        "</tr>";
                });
                tbody.html(trs);
                let page = ro.page;
                $("#first").text(page.first+1);
                $("#last").text(page.last);
                $("#amount").text(page.amount);
                $("#pageNum").text(page.pageNo);
                $("#pageAmount").text(page.pageAmount);
                lastPage = page.pageAmount;
            }
        },function (xhr) {
            alert(xhr.responseText);
        });

    };

    let toFirstPage = function () {
        $("#pageNo").val(1);
        list();
    }
    let toLastPage = function () {
        $("#pageNo").val(lastPage);
        list();
    }
    let nextPage = function () {
        let pageNoInput = $("#pageNo");
        let n = parseInt(pageNoInput.val())+1;
        if(n>lastPage){
            pageNoInput.val(lastPage);
        }else{
            pageNoInput.val(n);
        }
        list();
    }
    let prePage = function () {
        let pageNoInput = $("#pageNo");
        let n = parseInt(pageNoInput.val())-1;
        if(n<1){
            pageNoInput.val(1);
        }else{
            pageNoInput.val(n);
        }
        list();
    }
</script>
</body>
</html>